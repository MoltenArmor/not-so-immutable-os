#!/bin/sh
set -ue

# Track what has been tmpified for cleanup on interrupt
TMPIFIED_ETC=0
TMPIFIED_USR=0
TMPIFIED_APT=0
TMPIFIED_DPKG=0

cleanup_on_interrupt() {
    EXIT_STATUS="$?"
    # Clean up on failure (not on normal exit 0 or usage exit 2)
    if [ "${EXIT_STATUS}" -ne 0 ] && [ "${EXIT_STATUS}" -ne 2 ]; then
        # Restore in reverse order
        [ "${TMPIFIED_DPKG}" -eq 1 ] && tmpify -r /var/lib/dpkg > /dev/null 2>&1 || :
        [ "${TMPIFIED_APT}" -eq 1 ] && tmpify -r /var/lib/apt > /dev/null 2>&1 || :
        [ "${TMPIFIED_USR}" -eq 1 ] && systemctl --no-block try-reload-or-restart systemd-sysext.service || tmpify -r /usr > /dev/null 2>&1 || :
        [ "${TMPIFIED_ETC}" -eq 1 ] && systemctl --no-block try-reload-or-restart systemd-confext.service || tmpify -r /etc > /dev/null 2>&1 || :
    fi
}

trap cleanup_on_interrupt EXIT INT TERM

usage() {
    printf '%s\n' 'Usage: enter-rw'
    printf '%s\n' 'Enter testing mode with ephemeral /etc and /usr.'
}

check_user() {
    if [ "$(id -u)" -ne 0 ]; then
        printf '%s\n' "Error: This script must be run as root." >&2
        exit 1
    fi
}

is_sysext_merged() {
    [ -d /usr/.systemd-sysext/ ]
}

is_confext_merged() {
    [ -d /etc/.systemd-confext/ ]
}

is_sysext_ephemeral() {
    findmnt -t overlay -T /usr 2>/dev/null | grep -qF 'upperdir=/run/systemd/sysext/mh_workspace/usr'
}

is_confext_ephemeral() {
    findmnt -t overlay -T /etc 2>/dev/null | grep -qF 'upperdir=/run/systemd/sysext/mh_workspace/etc'
}

is_dir_tmpified() {
    [ -n "${1:-}" ] || return 1
    findmnt -t overlay -T "$1" 2>/dev/null | grep -qF 'upperdir=/run/tmpify'
}

tmpify_usr() {
    if is_sysext_merged; then
        if ! is_sysext_ephemeral; then
            if systemd-sysext refresh --mutable=ephemeral-import; then
                TMPIFIED_USR=1
                return 0
            else
                return 1
            fi
        fi
    else
        if ! is_dir_tmpified /usr; then
            if tmpify /usr; then
                TMPIFIED_USR=1
                return 0
            else
                return 1
            fi
        fi
    fi
    return 0
}

tmpify_etc() {
    if is_confext_merged; then
        if ! is_confext_ephemeral; then
            if systemd-confext refresh --noexec=no --mutable=ephemeral-import; then
                TMPIFIED_ETC=1
                return 0
            else
                return 1
            fi
        fi
    else
        if ! is_dir_tmpified /etc; then
            if tmpify /etc; then
                TMPIFIED_ETC=1
                return 0
            else
                return 1
            fi
        fi
    fi
    return 0
}

tmpify_package_metadata() {
    if ! is_dir_tmpified /var/lib/apt; then
        if tmpify /var/lib/apt; then
            TMPIFIED_APT=1
        else
            return 1
        fi
    fi

    if ! is_dir_tmpified /var/lib/dpkg; then
        if tmpify /var/lib/dpkg; then
            TMPIFIED_DPKG=1
        else
            return 1
        fi
    fi
    return 0
}

while [ "$#" -gt 0 ]; do
    case "$1" in
        '-h' | '--help')
            usage
            exit 0
            ;;
        -*)
            printf '%s\n' "Unknown option: $1" >&2
            usage
            exit 2
            ;;
        *)
            printf '%s\n' "Error: This command takes no arguments." >&2
            usage
            exit 2
            ;;
    esac
done

check_user

if tmpify_etc && tmpify_usr && tmpify_package_metadata; then
    printf '%s\n' 'Successfully entered RW mode.'
    exit 0
else
    printf '%s\n' 'Error: Failed to enter RW mode.' >&2
    exit 1
fi
