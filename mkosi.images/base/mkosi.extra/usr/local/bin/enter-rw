#!/bin/sh
set -ue

reload_or_restart() {
    systemctl --no-block reload-or-restart systemd-sysext.service systemd-confext.service
    tmpify -r /var/lib/apt || :
    tmpify -r /var/lib/dpkg || :
}

trap reload_or_restart HUP INT QUIT ABRT TERM

usage() {
    printf '%s\n' 'Enter testing mode with ephemeral /etc and /usr.'
    exit 0
}

check_user() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "Error: This script must be run as root." >&2
        exit 1
    fi
}

if [ "$#" -ne 0 ]; then
    usage
fi

check_user

if systemd-confext refresh --noexec=no --mutable=ephemeral && systemd-sysext refresh --mutable=ephemeral; then
    if tmpify /var/lib/apt && tmpify /var/lib/dpkg; then
        :
    else
        printf '%s\n' 'Error: Failed to tmpify /var/lib/apt or /var/lib/dpkg.' >&2
    fi
else
    printf '%s\n' 'Error: Failed to refresh systemd-confext or systemd-sysext.' >&2
fi
