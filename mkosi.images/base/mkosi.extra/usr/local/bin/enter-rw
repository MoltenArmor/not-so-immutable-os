#!/bin/sh
set -ue

reload_or_restart() {
    EXIT_STATUS="$?"
    if [ "${EXIT_STATUS}" -ne 0 ] && [ "${EXIT_STATUS}" -ne 254 ]; then
        systemctl --no-block try-reload-or-restart systemd-sysext.service systemd-confext.service
        tmpify -r /var/lib/apt > /dev/null || :
        tmpify -r /var/lib/dpkg > /dev/null || :
    fi
}

trap reload_or_restart EXIT

usage() {
    printf '%s\n' 'Enter testing mode with ephemeral /etc and /usr.'
}

check_user() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "Error: This script must be run as root." >&2
        exit 254
    fi
}

is_sysext_merged() {
    if [ -d /usr/.systemd-sysext/ ]; then
        return 0
    else
        return 1
    fi
}

is_confext_merged() {
    if [ -d /etc/.systemd-confext/ ]; then
        return 0
    else
        return 1
    fi
}

tmpify_usr() {
    if is_sysext_merged; then
        if systemd-sysext refresh --mutable=ephemeral-import > /dev/null; then
            return 0
        else
            return 1
        fi
    else
        if tmpify /usr > /dev/null; then
            return 0
        else
            return 1
        fi
    fi
}

tmpify_etc() {
    if is_confext_merged; then
        if systemd-confext refresh --noexec=no --mutable=ephemeral-import > /dev/null; then
            return 0
        else
            return 1
        fi
    else
        if tmpify /etc > /dev/null; then
            return 0
        else
            return 1
        fi
    fi
}

if [ "$#" -ne 0 ]; then
    usage
    exit 0
fi

check_user

if tmpify_etc && tmpify_usr; then
    if tmpify /var/lib/apt > /dev/null && tmpify /var/lib/dpkg > /dev/null; then
        printf '%s\n' 'Successfully entered RW mode.'
        exit 0
    else
        printf '%s\n' 'Error: Failed to tmpify /var/lib/apt or /var/lib/dpkg.' >&2
        exit 1
    fi
else
    printf '%s\n' 'Error: Failed to refresh systemd-confext or systemd-sysext.' >&2
    exit 1
fi
